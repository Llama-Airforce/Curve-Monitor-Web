import{f as _,a as b,t as y}from"./timestamp-X9wFVw8g.js";import{t as d,f as c,g as u,b as v,a as h}from"./timestamp-DkvXAN4c.js";import{g as f}from"./api-Bhu-jkhy.js";import{u as n}from"./useQuery-DI0f2pKh.js";import{f as o,u as g}from"./index-_TFeqcMs.js";const q=e=>({name:e.collateral_token.symbol,address:e.address,factoryAddress:e.factory_address,llamma:e.llamma,rate:e.rate,borrowed:e.total_debt,borrowable:e.borrowable,collateralAmount:e.collateral_amount,collateralAmountUsd:e.collateral_amount_usd,debtCeiling:e.debt_ceiling,loans:e.n_loans,collateralToken:{symbol:e.collateral_token.symbol,address:e.collateral_token.address},stablecoinToken:{symbol:e.stablecoin_token.symbol,address:e.stablecoin_token.address},fees:{pending:e.pending_fees,collected:e.collected_fees}}),k=e=>({timestamp:d(e.dt),rate:e.rate,nLoans:e.n_loans,minted:e.minted,redeemed:e.redeemed,totalCollateral:e.total_collateral,totalCollateralUsd:e.total_collateral_usd,totalStablecoin:e.total_stablecoin,totalDebt:e.total_debt,priceAMM:e.amm_price,priceOracle:e.price_oracle,borrowable:e.borrowable,discountLiquidation:e.liquidation_discount,discountLoan:e.loan_discount}),$=e=>({address:e.address,pool:e.pool,poolAddress:e.pool_address,pair:e.pair.map(t=>({symbol:t.symbol,address:t.address})),active:e.active,totalDebt:e.total_debt,totalProfit:e.total_profit}),U=e=>({timestamp:d(e.timestamp),market:e.market,supply:e.supply,borrowable:e.borrowable}),w=e=>e.markets.map(t=>({collateral:t.collateral,controller:t.controller,snapshotFirst:d(t.first_snapshot),snapshotLast:d(t.last_snapshot)})),K=e=>({health:e.health,healthFull:e.health_full,n:e.n,n1:e.n1,n2:e.n2,debt:e.debt,collateral:e.collateral,collateralUp:e.collateral_up,stablecoin:e.stablecoin,softLiquidation:e.soft_liquidation,totalDeposited:e.total_deposited,loss:e.loss,lossPct:e.loss_pct,oraclePrice:e.oracle_price,blockNumber:e.block_number,timestamp:d(e.timestamp)}),M=e=>e.data.map(K),F=e=>({controller:e.controller,user:e.user,totalDeposit:e.total_deposit,totalDepositPrecise:e.total_deposit_precise,totalDepositUsd:e.total_deposit_usd_value,totalBorrowed:e.total_borrowed,totalBorrowedPrecise:e.total_borrowed_precise,events:e.data.map(t=>({timestamp:d(t.dt),txHash:t.transaction_hash,type:t.type,user:t.user,collateralChange:t.collateral_change,collateralChangeUsd:t.collateral_change_usd??void 0,loanChange:t.loan_change,loanChangeUsd:t.loan_change_usd??void 0,liquidation:t.liquidation===null?void 0:{user:t.liquidation.user,liquidator:t.liquidation.liquidator,collateralReceived:t.liquidation.collateral_received,collateralReceivedUsd:t.liquidation.collateral_received_usd,stablecoinReceived:t.liquidation.stablecoin_received,debt:t.liquidation.debt},n1:t.n1,n2:t.n2,oraclePrice:t.oracle_price}))});async function S(e,t={fetch_on_chain:!0},a){const s=u(a);return(await c(`${s}/v1/crvusd/markets/${e}${v(t)}`)).data.map(q)}async function D(e,t,a={fetch_on_chain:!0,agg:"day"},s){const r=u(s);return(await c(`${r}/v1/crvusd/markets/${e}/${t}/snapshots${v(a)}`)).data.map(k)}async function C(e,t,a){const s=u(a),r=h({daysRange:t});return(await c(`${s}/v1/crvusd/markets/${e}/supply${v(r)}`)).data.map(U)}async function A(e,t){const a=u(t);return(await c(`${a}/v1/crvusd/pegkeepers/${e}`)).keepers.map($)}async function Q(e,t,a){const s=u(a),r=await c(`${s}/v1/crvusd/users/${t}/${e}?page=1&per_page=100&include_closed=false`);return w(r)}async function P(e,t,a,s){const r=u(s),l=await c(`${r}/v1/crvusd/users/${t}/${e}/${a}/snapshots?page=1&per_page=100`);return M(l)}async function L(e,t,a,s){const r=u(s),l=await c(`${r}/v1/crvusd/collateral_events/${t}/${a}/${e}`);return F(l)}function p(){return{initialData:[],initialDataUpdatedAt:0}}function j(e=30){const t=o(()=>g(e));return n({queryKey:["crvusd-supply",t],queryFn:()=>C("ethereum",t.value),...p()})}function V(e){return n({queryKey:["crvusd-market-snapshots",o(()=>e.value?.address)],queryFn:({queryKey:[,t]})=>D("ethereum",t),enabled:o(()=>!!e.value),...p()})}function z(e){return n({queryKey:["crvusd-keepers-prices",o(()=>[...new Set(e.value.map(t=>t.poolAddress))])],queryFn:async()=>{const t=e.value.map(async r=>{const l=r.pair.find(i=>i.symbol!=="crvUSD"),m=r.pair.find(i=>i.symbol==="crvUSD");return!l||!m?[]:(await f("ethereum",r.poolAddress,l.address,m.address)).map(i=>({time:i.time,price:(i.high+i.low)/2,coin:l.symbol}))}),s=(await Promise.all(t)).flat().groupBy(r=>r.time.getTime()).entries().map(([r,l])=>({timestamp:Number(r)/1e3,...Object.fromEntries(l.map(m=>[m.coin,m.price]))}));return s.length>0?s:[{timestamp:0}]},initialData:[{timestamp:0}],initialDataUpdatedAt:0})}function G(){return n({queryKey:["crvusd-markets"],queryFn:()=>S("ethereum",{page:1}),...p()})}function I(){return n({queryKey:["crvusd-keepers"],queryFn:()=>A("ethereum"),...p()})}function W(e,t){return n({queryKey:["crvusd-user-markets",o(()=>e.value),o(()=>t.value)],queryFn:({queryKey:[,a,s]})=>Q(a,s),enabled:o(()=>!!e.value&&!!t.value),...p()})}function X(e,t,a){return n({queryKey:["crvusd-user-market-snapshots",o(()=>e.value),o(()=>t.value),o(()=>a.value)],queryFn:({queryKey:[,s,r,l]})=>P(s,r,l),enabled:o(()=>!!e.value&&!!t.value&&!!a.value),...p()})}function Y(e,t,a){return n({queryKey:["crvusd-user-market-events",o(()=>e.value),o(()=>t.value),o(()=>a.value)],queryFn:({queryKey:[,s,r,l]})=>L(s,r,l),enabled:o(()=>!!e.value&&!!t.value&&!!a.value)})}const R=e=>({user:e.user,first:y(e.first),last:y(e.last),debt:parseFloat(e.debt),health:parseFloat(e.health),healthFull:parseFloat(e.health_full),loss:parseFloat(e.loss),stablecoin:parseFloat(e.stablecoin),softLiquidation:e.soft_liquidation});async function E(e,t,a,s){const r=u(s);return(await _(`${r}/v1/crvusd/users/${e}/${t}/users${b(a)}`)).data.map(R)}function Z(e,t){return n({queryKey:["crvusd-market-all-users",o(()=>e.value),o(()=>t.value)],queryFn:({queryKey:[,a,s]})=>E(a,s,{per_page:1e3}),enabled:o(()=>!!e.value&&!!t.value)})}export{X as a,Y as b,W as c,j as d,V as e,Z as f,I as g,z as h,G as u};
