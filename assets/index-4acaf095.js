import{i as qe,g as Ae,d as je,a as ae,s as Ue,r as ue,b as X,c as Ne,m as ee}from"./mobile-73b729d9.js";import{aV as N,aW as Fe,aX as m,aY as L,aZ as xe,a_ as te}from"./index-a3b30fe6.js";const Pe=["session_request","session_update","exchange_key","connect","disconnect","display_uri","modal_closed","transport_open","transport_close","transport_error"],he=["eth_sendTransaction","eth_signTransaction","eth_sign","eth_signTypedData","eth_signTypedData_v1","eth_signTypedData_v2","eth_signTypedData_v3","eth_signTypedData_v4","personal_sign","wallet_addEthereumChain","wallet_switchEthereumChain","wallet_getPermissions","wallet_requestPermissions","wallet_registerOnboarding","wallet_watchAsset","wallet_scanQRCode"];var Be=G;G.strict=de;G.loose=fe;var Le=Object.prototype.toString,He={"[object Int8Array]":!0,"[object Int16Array]":!0,"[object Int32Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Uint16Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0};function G(t){return de(t)||fe(t)}function de(t){return t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array}function fe(t){return He[Le.call(t)]}var $e=Be.strict,De=function(e){if($e(e)){var r=N.Buffer.from(e.buffer);return e.byteLength!==e.buffer.byteLength&&(r=r.slice(e.byteOffset,e.byteOffset+e.byteLength)),r}else return N.Buffer.from(e)};const le="hex",pe="utf8",x="0";function T(t){return new Uint8Array(t)}function _e(t,e=!1){const r=t.toString(le);return e?C(r):r}function We(t){return t.toString(pe)}function P(t){return De(t)}function O(t,e=!1){return _e(P(t),e)}function Je(t){return We(P(t))}function Qe(t){return N.Buffer.from(v(t),le)}function M(t){return T(Qe(t))}function K(t){return N.Buffer.from(t,pe)}function Ge(t){return T(K(t))}function Ke(t,e=!1){return _e(K(t),e)}function Ve(t,e){return!(typeof t!="string"||!t.match(/^0x[0-9A-Fa-f]*$/)||e&&t.length!==2+2*e)}function ge(...t){let e=[];return t.forEach(r=>e=e.concat(Array.from(r))),new Uint8Array([...e])}function Ye(t,e=8){const r=t%e;return r?(t-r)/e*e+e:t}function Ze(t,e=8,r=x){return ze(t,Ye(t.length,e),r)}function ze(t,e,r=x){return et(t,e,!0,r)}function v(t){return t.replace(/^0x/,"")}function C(t){return t.startsWith("0x")?t:`0x${t}`}function ye(t){return t=v(t),t=Ze(t,2),t&&(t=C(t)),t}function Xe(t){const e=t.startsWith("0x");return t=v(t),t=t.startsWith(x)?t.substring(1):t,e?C(t):t}function et(t,e,r,n=x){const s=e-t.length;let c=t;if(s>0){const f=n.repeat(s);c=r?f+t:t+f}return c}function W(t){return P(new Uint8Array(t))}function tt(t,e){return O(new Uint8Array(t),!e)}function rt(t){return T(t).buffer}function nt(t){return K(t)}function st(t,e){return Ke(t,!e)}function it(t){return M(t).buffer}function me(t,e){const r=v(ye(new Fe(t).toString(16)));return e?r:C(r)}var q={},I={};Object.defineProperty(I,"__esModule",{value:!0});I.isBrowserCryptoAvailable=I.getSubtleCrypto=I.getBrowerCrypto=void 0;function V(){return(m===null||m===void 0?void 0:m.crypto)||(m===null||m===void 0?void 0:m.msCrypto)||{}}I.getBrowerCrypto=V;function be(){const t=V();return t.subtle||t.webkitSubtle}I.getSubtleCrypto=be;function ot(){return!!V()&&!!be()}I.isBrowserCryptoAvailable=ot;var R={};Object.defineProperty(R,"__esModule",{value:!0});R.isBrowser=R.isNode=R.isReactNative=void 0;function Se(){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"}R.isReactNative=Se;function we(){return typeof L<"u"&&typeof L.versions<"u"&&typeof L.versions.node<"u"}R.isNode=we;function ct(){return!Se()&&!we()}R.isBrowser=ct;(function(t){var e=m&&m.__createBinding||(Object.create?function(n,s,c,f){f===void 0&&(f=c),Object.defineProperty(n,f,{enumerable:!0,get:function(){return s[c]}})}:function(n,s,c,f){f===void 0&&(f=c),n[f]=s[c]}),r=m&&m.__exportStar||function(n,s){for(var c in n)c!=="default"&&!s.hasOwnProperty(c)&&e(s,n,c)};Object.defineProperty(t,"__esModule",{value:!0}),r(I,t),r(R,t)})(q);function at(){const t=Date.now()*Math.pow(10,3),e=Math.floor(Math.random()*Math.pow(10,3));return t+e}function U(t){return ye(t)}function ut(t){return Xe(C(t))}const ht=at;function H(){return((e,r)=>{for(r=e="";e++<36;r+=e*51&52?(e^15?8^Math.random()*(e^20?16:4):4).toString(16):"-");return r})()}function dt(t){return t===""||typeof t=="string"&&t.trim()===""}function ft(t){return!(t&&t.length)}function Ie(t,e){return Ve(t,e)}function lt(t){return typeof t.method<"u"}function j(t){return typeof t.result<"u"}function F(t){return typeof t.error<"u"}function re(t){return typeof t.event<"u"}function pt(t){return Pe.includes(t)||t.startsWith("wc_")}function _t(t){return t.method.startsWith("wc_")?!0:!he.includes(t.method)}function gt(t){t=v(t.toLowerCase());const e=v(xe.keccak_256(nt(t)));let r="";for(let n=0;n<t.length;n++)parseInt(e[n],16)>7?r+=t[n].toUpperCase():r+=t[n];return C(r)}const yt=t=>t?t.toLowerCase().substring(0,2)!=="0x"?!1:/^(0x)?[0-9a-f]{40}$/i.test(t)?/^(0x)?[0-9a-f]{40}$/.test(t)||/^(0x)?[0-9A-F]{40}$/.test(t)?!0:t===gt(t):!1:!1;function ne(t){return!ft(t)&&!Ie(t[0])&&(t[0]=st(t[0])),t}function $(t){if(typeof t.type<"u"&&t.type!=="0")return t;if(typeof t.from>"u"||!yt(t.from))throw new Error("Transaction object must include a valid 'from' value.");function e(s){let c=s;return(typeof s=="number"||typeof s=="string"&&!dt(s))&&(Ie(s)?typeof s=="string"&&(c=U(s)):c=me(s)),typeof c=="string"&&(c=ut(c)),c}const r={from:U(t.from),to:typeof t.to>"u"?void 0:U(t.to),gasPrice:typeof t.gasPrice>"u"?"":e(t.gasPrice),gas:typeof t.gas>"u"?typeof t.gasLimit>"u"?"":e(t.gasLimit):e(t.gas),value:typeof t.value>"u"?"":e(t.value),nonce:typeof t.nonce>"u"?"":e(t.nonce),data:typeof t.data>"u"?"":U(t.data)||"0x"},n=["gasPrice","gas","value","nonce"];return Object.keys(r).forEach(s=>{(typeof r[s]>"u"||typeof r[s]=="string"&&!r[s].trim().length)&&n.includes(s)&&delete r[s]}),r}function mt(t){const e=t.message||"Failed or Rejected Request";let r=-32e3;if(t&&!t.code)switch(e){case"Parse error":r=-32700;break;case"Invalid request":r=-32600;break;case"Method not found":r=-32601;break;case"Invalid params":r=-32602;break;case"Internal error":r=-32603;break;default:r=-32e3;break}return{code:r,message:e}}var Y={},bt=t=>encodeURIComponent(t).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`),Re="%[a-f0-9]{2}",se=new RegExp("("+Re+")|([^%]+?)","gi"),ie=new RegExp("("+Re+")+","gi");function J(t,e){try{return[decodeURIComponent(t.join(""))]}catch{}if(t.length===1)return t;e=e||1;var r=t.slice(0,e),n=t.slice(e);return Array.prototype.concat.call([],J(r),J(n))}function St(t){try{return decodeURIComponent(t)}catch{for(var e=t.match(se)||[],r=1;r<e.length;r++)t=J(e,r).join(""),e=t.match(se)||[];return t}}function wt(t){for(var e={"%FE%FF":"��","%FF%FE":"��"},r=ie.exec(t);r;){try{e[r[0]]=decodeURIComponent(r[0])}catch{var n=St(r[0]);n!==r[0]&&(e[r[0]]=n)}r=ie.exec(t)}e["%C2"]="�";for(var s=Object.keys(e),c=0;c<s.length;c++){var f=s[c];t=t.replace(new RegExp(f,"g"),e[f])}return t}var It=function(t){if(typeof t!="string")throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof t+"`");try{return t=t.replace(/\+/g," "),decodeURIComponent(t)}catch{return wt(t)}},Rt=(t,e)=>{if(!(typeof t=="string"&&typeof e=="string"))throw new TypeError("Expected the arguments to be of type `string`");if(e==="")return[t];const r=t.indexOf(e);return r===-1?[t]:[t.slice(0,r),t.slice(r+e.length)]};(function(t){const e=bt,r=It,n=Rt,s=i=>i==null;function c(i){switch(i.arrayFormat){case"index":return o=>(u,a)=>{const h=u.length;return a===void 0||i.skipNull&&a===null||i.skipEmptyString&&a===""?u:a===null?[...u,[l(o,i),"[",h,"]"].join("")]:[...u,[l(o,i),"[",l(h,i),"]=",l(a,i)].join("")]};case"bracket":return o=>(u,a)=>a===void 0||i.skipNull&&a===null||i.skipEmptyString&&a===""?u:a===null?[...u,[l(o,i),"[]"].join("")]:[...u,[l(o,i),"[]=",l(a,i)].join("")];case"comma":case"separator":return o=>(u,a)=>a==null||a.length===0?u:u.length===0?[[l(o,i),"=",l(a,i)].join("")]:[[u,l(a,i)].join(i.arrayFormatSeparator)];default:return o=>(u,a)=>a===void 0||i.skipNull&&a===null||i.skipEmptyString&&a===""?u:a===null?[...u,l(o,i)]:[...u,[l(o,i),"=",l(a,i)].join("")]}}function f(i){let o;switch(i.arrayFormat){case"index":return(u,a,h)=>{if(o=/\[(\d*)\]$/.exec(u),u=u.replace(/\[\d*\]$/,""),!o){h[u]=a;return}h[u]===void 0&&(h[u]={}),h[u][o[1]]=a};case"bracket":return(u,a,h)=>{if(o=/(\[\])$/.exec(u),u=u.replace(/\[\]$/,""),!o){h[u]=a;return}if(h[u]===void 0){h[u]=[a];return}h[u]=[].concat(h[u],a)};case"comma":case"separator":return(u,a,h)=>{const d=typeof a=="string"&&a.split("").indexOf(i.arrayFormatSeparator)>-1?a.split(i.arrayFormatSeparator).map(y=>g(y,i)):a===null?a:g(a,i);h[u]=d};default:return(u,a,h)=>{if(h[u]===void 0){h[u]=a;return}h[u]=[].concat(h[u],a)}}}function _(i){if(typeof i!="string"||i.length!==1)throw new TypeError("arrayFormatSeparator must be single character string")}function l(i,o){return o.encode?o.strict?e(i):encodeURIComponent(i):i}function g(i,o){return o.decode?r(i):i}function A(i){return Array.isArray(i)?i.sort():typeof i=="object"?A(Object.keys(i)).sort((o,u)=>Number(o)-Number(u)).map(o=>i[o]):i}function b(i){const o=i.indexOf("#");return o!==-1&&(i=i.slice(0,o)),i}function S(i){let o="";const u=i.indexOf("#");return u!==-1&&(o=i.slice(u)),o}function w(i){i=b(i);const o=i.indexOf("?");return o===-1?"":i.slice(o+1)}function B(i,o){return o.parseNumbers&&!Number.isNaN(Number(i))&&typeof i=="string"&&i.trim()!==""?i=Number(i):o.parseBooleans&&i!==null&&(i.toLowerCase()==="true"||i.toLowerCase()==="false")&&(i=i.toLowerCase()==="true"),i}function z(i,o){o=Object.assign({decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1},o),_(o.arrayFormatSeparator);const u=f(o),a=Object.create(null);if(typeof i!="string"||(i=i.trim().replace(/^[?#&]/,""),!i))return a;for(const h of i.split("&")){let[p,d]=n(o.decode?h.replace(/\+/g," "):h,"=");d=d===void 0?null:["comma","separator"].includes(o.arrayFormat)?d:g(d,o),u(g(p,o),d,a)}for(const h of Object.keys(a)){const p=a[h];if(typeof p=="object"&&p!==null)for(const d of Object.keys(p))p[d]=B(p[d],o);else a[h]=B(p,o)}return o.sort===!1?a:(o.sort===!0?Object.keys(a).sort():Object.keys(a).sort(o.sort)).reduce((h,p)=>{const d=a[p];return Boolean(d)&&typeof d=="object"&&!Array.isArray(d)?h[p]=A(d):h[p]=d,h},Object.create(null))}t.extract=w,t.parse=z,t.stringify=(i,o)=>{if(!i)return"";o=Object.assign({encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:","},o),_(o.arrayFormatSeparator);const u=d=>o.skipNull&&s(i[d])||o.skipEmptyString&&i[d]==="",a=c(o),h={};for(const d of Object.keys(i))u(d)||(h[d]=i[d]);const p=Object.keys(h);return o.sort!==!1&&p.sort(o.sort),p.map(d=>{const y=i[d];return y===void 0?"":y===null?l(d,o):Array.isArray(y)?y.reduce(a(d),[]).join("&"):l(d,o)+"="+l(y,o)}).filter(d=>d.length>0).join("&")},t.parseUrl=(i,o)=>{o=Object.assign({decode:!0},o);const[u,a]=n(i,"#");return Object.assign({url:u.split("?")[0]||"",query:z(w(i),o)},o&&o.parseFragmentIdentifier&&a?{fragmentIdentifier:g(a,o)}:{})},t.stringifyUrl=(i,o)=>{o=Object.assign({encode:!0,strict:!0},o);const u=b(i.url).split("?")[0]||"",a=t.extract(i.url),h=t.parse(a,{sort:!1}),p=Object.assign(h,i.query);let d=t.stringify(p,o);d&&(d=`?${d}`);let y=S(i.url);return i.fragmentIdentifier&&(y=`#${l(i.fragmentIdentifier,o)}`),`${u}${d}${y}`}})(Y);function vt(t){const e=t.indexOf("?")!==-1?t.indexOf("?"):void 0;return typeof e<"u"?t.substr(e):""}function kt(t,e){let r=ve(t);return r=Object.assign(Object.assign({},r),e),t=Et(r),t}function ve(t){return Y.parse(t)}function Et(t){return Y.stringify(t)}function Ot(t){return typeof t.bridge<"u"}function Mt(t){const e=t.indexOf(":"),r=t.indexOf("?")!==-1?t.indexOf("?"):void 0,n=t.substring(0,e),s=t.substring(e+1,r);function c(b){const S="@",w=b.split(S);return{handshakeTopic:w[0],version:parseInt(w[1],10)}}const f=c(s),_=typeof r<"u"?t.substr(r):"";function l(b){const S=ve(b);return{key:S.key||"",bridge:S.bridge||""}}const g=l(_);return Object.assign(Object.assign({protocol:n},f),g)}class Tt{constructor(){this._eventEmitters=[],typeof window<"u"&&typeof window.addEventListener<"u"&&(window.addEventListener("online",()=>this.trigger("online")),window.addEventListener("offline",()=>this.trigger("offline")))}on(e,r){this._eventEmitters.push({event:e,callback:r})}trigger(e){let r=[];e&&(r=this._eventEmitters.filter(n=>n.event===e)),r.forEach(n=>{n.callback()})}}const Ct=typeof te.WebSocket<"u"?te.WebSocket:require("ws");class qt{constructor(e){if(this.opts=e,this._queue=[],this._events=[],this._subscriptions=[],this._protocol=e.protocol,this._version=e.version,this._url="",this._netMonitor=null,this._socket=null,this._nextSocket=null,this._subscriptions=e.subscriptions||[],this._netMonitor=e.netMonitor||new Tt,!e.url||typeof e.url!="string")throw new Error("Missing or invalid WebSocket url");this._url=e.url,this._netMonitor.on("online",()=>this._socketCreate())}set readyState(e){}get readyState(){return this._socket?this._socket.readyState:-1}set connecting(e){}get connecting(){return this.readyState===0}set connected(e){}get connected(){return this.readyState===1}set closing(e){}get closing(){return this.readyState===2}set closed(e){}get closed(){return this.readyState===3}open(){this._socketCreate()}close(){this._socketClose()}send(e,r,n){if(!r||typeof r!="string")throw new Error("Missing or invalid topic field");this._socketSend({topic:r,type:"pub",payload:e,silent:!!n})}subscribe(e){this._socketSend({topic:e,type:"sub",payload:"",silent:!0})}on(e,r){this._events.push({event:e,callback:r})}_socketCreate(){if(this._nextSocket)return;const e=At(this._url,this._protocol,this._version);if(this._nextSocket=new Ct(e),!this._nextSocket)throw new Error("Failed to create socket");this._nextSocket.onmessage=r=>this._socketReceive(r),this._nextSocket.onopen=()=>this._socketOpen(),this._nextSocket.onerror=r=>this._socketError(r),this._nextSocket.onclose=()=>{setTimeout(()=>{this._nextSocket=null,this._socketCreate()},1e3)}}_socketOpen(){this._socketClose(),this._socket=this._nextSocket,this._nextSocket=null,this._queueSubscriptions(),this._pushQueue()}_socketClose(){this._socket&&(this._socket.onclose=()=>{},this._socket.close())}_socketSend(e){const r=JSON.stringify(e);this._socket&&this._socket.readyState===1?this._socket.send(r):(this._setToQueue(e),this._socketCreate())}async _socketReceive(e){let r;try{r=JSON.parse(e.data)}catch{return}if(this._socketSend({topic:r.topic,type:"ack",payload:"",silent:!0}),this._socket&&this._socket.readyState===1){const n=this._events.filter(s=>s.event==="message");n&&n.length&&n.forEach(s=>s.callback(r))}}_socketError(e){const r=this._events.filter(n=>n.event==="error");r&&r.length&&r.forEach(n=>n.callback(e))}_queueSubscriptions(){this._subscriptions.forEach(r=>this._queue.push({topic:r,type:"sub",payload:"",silent:!0})),this._subscriptions=this.opts.subscriptions||[]}_setToQueue(e){this._queue.push(e)}_pushQueue(){this._queue.forEach(r=>this._socketSend(r)),this._queue=[]}}function At(t,e,r){var n,s;const f=(t.startsWith("https")?t.replace("https","wss"):t.startsWith("http")?t.replace("http","ws"):t).split("?"),_=qe()?{protocol:e,version:r,env:"browser",host:((n=Ae())===null||n===void 0?void 0:n.host)||""}:{protocol:e,version:r,env:((s=je())===null||s===void 0?void 0:s.name)||""},l=kt(vt(f[1]||""),_);return f[0]+"?"+l}const D="Session currently connected",E="Session currently disconnected",jt="Session Rejected",Ut="Missing JSON RPC response",Nt='JSON-RPC success response must include "result" field',Ft='JSON-RPC error response must include "error" field',xt='JSON RPC request must have valid "method" value',Pt='JSON RPC request must have valid "id" value',Bt="Missing one of the required parameters: bridge / uri / session",oe="JSON RPC response format is invalid",Lt="URI format is invalid",Ht="QRCode Modal not provided",ce="User close QRCode Modal";class $t{constructor(){this._eventEmitters=[]}subscribe(e){this._eventEmitters.push(e)}unsubscribe(e){this._eventEmitters=this._eventEmitters.filter(r=>r.event!==e)}trigger(e){let r=[],n;lt(e)?n=e.method:j(e)||F(e)?n=`response:${e.id}`:re(e)?n=e.event:n="",n&&(r=this._eventEmitters.filter(s=>s.event===n)),(!r||!r.length)&&!pt(n)&&!re(n)&&(r=this._eventEmitters.filter(s=>s.event==="call_request")),r.forEach(s=>{if(F(e)){const c=new Error(e.error.message);s.callback(c,null)}else s.callback(null,e)})}}class Dt{constructor(e="walletconnect"){this.storageId=e}getSession(){let e=null;const r=ae(this.storageId);return r&&Ot(r)&&(e=r),e}setSession(e){return Ue(this.storageId,e),e}removeSession(){ue(this.storageId)}}const Wt="walletconnect.org",Jt="abcdefghijklmnopqrstuvwxyz0123456789",ke=Jt.split("").map(t=>`https://${t}.bridge.walletconnect.org`);function Qt(t){let e=t.indexOf("//")>-1?t.split("/")[2]:t.split("/")[0];return e=e.split(":")[0],e=e.split("?")[0],e}function Gt(t){return Qt(t).split(".").slice(-2).join(".")}function Kt(){return Math.floor(Math.random()*ke.length)}function Vt(){return ke[Kt()]}function Yt(t){return Gt(t)===Wt}function Zt(t){return Yt(t)?Vt():t}class zt{constructor(e){if(this.protocol="wc",this.version=1,this._bridge="",this._key=null,this._clientId="",this._clientMeta=null,this._peerId="",this._peerMeta=null,this._handshakeId=0,this._handshakeTopic="",this._connected=!1,this._accounts=[],this._chainId=0,this._networkId=0,this._rpcUrl="",this._eventManager=new $t,this._clientMeta=X()||e.connectorOpts.clientMeta||null,this._cryptoLib=e.cryptoLib,this._sessionStorage=e.sessionStorage||new Dt(e.connectorOpts.storageId),this._qrcodeModal=e.connectorOpts.qrcodeModal,this._qrcodeModalOptions=e.connectorOpts.qrcodeModalOptions,this._signingMethods=[...he,...e.connectorOpts.signingMethods||[]],!e.connectorOpts.bridge&&!e.connectorOpts.uri&&!e.connectorOpts.session)throw new Error(Bt);e.connectorOpts.bridge&&(this.bridge=Zt(e.connectorOpts.bridge)),e.connectorOpts.uri&&(this.uri=e.connectorOpts.uri);const r=e.connectorOpts.session||this._getStorageSession();r&&(this.session=r),this.handshakeId&&this._subscribeToSessionResponse(this.handshakeId,"Session request rejected"),this._transport=e.transport||new qt({protocol:this.protocol,version:this.version,url:this.bridge,subscriptions:[this.clientId]}),this._subscribeToInternalEvents(),this._initTransport(),e.connectorOpts.uri&&this._subscribeToSessionRequest(),e.pushServerOpts&&this._registerPushServer(e.pushServerOpts)}set bridge(e){e&&(this._bridge=e)}get bridge(){return this._bridge}set key(e){if(!e)return;const r=it(e);this._key=r}get key(){return this._key?tt(this._key,!0):""}set clientId(e){e&&(this._clientId=e)}get clientId(){let e=this._clientId;return e||(e=this._clientId=H()),this._clientId}set peerId(e){e&&(this._peerId=e)}get peerId(){return this._peerId}set clientMeta(e){}get clientMeta(){let e=this._clientMeta;return e||(e=this._clientMeta=X()),e}set peerMeta(e){this._peerMeta=e}get peerMeta(){return this._peerMeta}set handshakeTopic(e){e&&(this._handshakeTopic=e)}get handshakeTopic(){return this._handshakeTopic}set handshakeId(e){e&&(this._handshakeId=e)}get handshakeId(){return this._handshakeId}get uri(){return this._formatUri()}set uri(e){if(!e)return;const{handshakeTopic:r,bridge:n,key:s}=this._parseUri(e);this.handshakeTopic=r,this.bridge=n,this.key=s}set chainId(e){this._chainId=e}get chainId(){return this._chainId}set networkId(e){this._networkId=e}get networkId(){return this._networkId}set accounts(e){this._accounts=e}get accounts(){return this._accounts}set rpcUrl(e){this._rpcUrl=e}get rpcUrl(){return this._rpcUrl}set connected(e){}get connected(){return this._connected}set pending(e){}get pending(){return!!this._handshakeTopic}get session(){return{connected:this.connected,accounts:this.accounts,chainId:this.chainId,bridge:this.bridge,key:this.key,clientId:this.clientId,clientMeta:this.clientMeta,peerId:this.peerId,peerMeta:this.peerMeta,handshakeId:this.handshakeId,handshakeTopic:this.handshakeTopic}}set session(e){e&&(this._connected=e.connected,this.accounts=e.accounts,this.chainId=e.chainId,this.bridge=e.bridge,this.key=e.key,this.clientId=e.clientId,this.clientMeta=e.clientMeta,this.peerId=e.peerId,this.peerMeta=e.peerMeta,this.handshakeId=e.handshakeId,this.handshakeTopic=e.handshakeTopic)}on(e,r){const n={event:e,callback:r};this._eventManager.subscribe(n)}off(e){this._eventManager.unsubscribe(e)}async createInstantRequest(e){this._key=await this._generateKey();const r=this._formatRequest({method:"wc_instantRequest",params:[{peerId:this.clientId,peerMeta:this.clientMeta,request:this._formatRequest(e)}]});this.handshakeId=r.id,this.handshakeTopic=H(),this._eventManager.trigger({event:"display_uri",params:[this.uri]}),this.on("modal_closed",()=>{throw new Error(ce)});const n=()=>{this.killSession()};try{const s=await this._sendCallRequest(r);return s&&n(),s}catch(s){throw n(),s}}async connect(e){if(!this._qrcodeModal)throw new Error(Ht);return this.connected?{chainId:this.chainId,accounts:this.accounts}:(await this.createSession(e),new Promise(async(r,n)=>{this.on("modal_closed",()=>n(new Error(ce))),this.on("connect",(s,c)=>{if(s)return n(s);r(c.params[0])})}))}async createSession(e){if(this._connected)throw new Error(D);if(this.pending)return;this._key=await this._generateKey();const r=this._formatRequest({method:"wc_sessionRequest",params:[{peerId:this.clientId,peerMeta:this.clientMeta,chainId:e&&e.chainId?e.chainId:null}]});this.handshakeId=r.id,this.handshakeTopic=H(),this._sendSessionRequest(r,"Session update rejected",{topic:this.handshakeTopic}),this._eventManager.trigger({event:"display_uri",params:[this.uri]})}approveSession(e){if(this._connected)throw new Error(D);this.chainId=e.chainId,this.accounts=e.accounts,this.networkId=e.networkId||0,this.rpcUrl=e.rpcUrl||"";const r={approved:!0,chainId:this.chainId,networkId:this.networkId,accounts:this.accounts,rpcUrl:this.rpcUrl,peerId:this.clientId,peerMeta:this.clientMeta},n={id:this.handshakeId,jsonrpc:"2.0",result:r};this._sendResponse(n),this._connected=!0,this._setStorageSession(),this._eventManager.trigger({event:"connect",params:[{peerId:this.peerId,peerMeta:this.peerMeta,chainId:this.chainId,accounts:this.accounts}]})}rejectSession(e){if(this._connected)throw new Error(D);const r=e&&e.message?e.message:jt,n=this._formatResponse({id:this.handshakeId,error:{message:r}});this._sendResponse(n),this._connected=!1,this._eventManager.trigger({event:"disconnect",params:[{message:r}]}),this._removeStorageSession()}updateSession(e){if(!this._connected)throw new Error(E);this.chainId=e.chainId,this.accounts=e.accounts,this.networkId=e.networkId||0,this.rpcUrl=e.rpcUrl||"";const r={approved:!0,chainId:this.chainId,networkId:this.networkId,accounts:this.accounts,rpcUrl:this.rpcUrl},n=this._formatRequest({method:"wc_sessionUpdate",params:[r]});this._sendSessionRequest(n,"Session update rejected"),this._eventManager.trigger({event:"session_update",params:[{chainId:this.chainId,accounts:this.accounts}]}),this._manageStorageSession()}async killSession(e){const r=e?e.message:"Session Disconnected",n={approved:!1,chainId:null,networkId:null,accounts:null},s=this._formatRequest({method:"wc_sessionUpdate",params:[n]});await this._sendRequest(s),this._handleSessionDisconnect(r)}async sendTransaction(e){if(!this._connected)throw new Error(E);const r=$(e),n=this._formatRequest({method:"eth_sendTransaction",params:[r]});return await this._sendCallRequest(n)}async signTransaction(e){if(!this._connected)throw new Error(E);const r=$(e),n=this._formatRequest({method:"eth_signTransaction",params:[r]});return await this._sendCallRequest(n)}async signMessage(e){if(!this._connected)throw new Error(E);const r=this._formatRequest({method:"eth_sign",params:e});return await this._sendCallRequest(r)}async signPersonalMessage(e){if(!this._connected)throw new Error(E);e=ne(e);const r=this._formatRequest({method:"personal_sign",params:e});return await this._sendCallRequest(r)}async signTypedData(e){if(!this._connected)throw new Error(E);const r=this._formatRequest({method:"eth_signTypedData",params:e});return await this._sendCallRequest(r)}async updateChain(e){if(!this._connected)throw new Error("Session currently disconnected");const r=this._formatRequest({method:"wallet_updateChain",params:[e]});return await this._sendCallRequest(r)}unsafeSend(e,r){return this._sendRequest(e,r),this._eventManager.trigger({event:"call_request_sent",params:[{request:e,options:r}]}),new Promise((n,s)=>{this._subscribeToResponse(e.id,(c,f)=>{if(c){s(c);return}if(!f)throw new Error(Ut);n(f)})})}async sendCustomRequest(e,r){if(!this._connected)throw new Error(E);switch(e.method){case"eth_accounts":return this.accounts;case"eth_chainId":return me(this.chainId);case"eth_sendTransaction":case"eth_signTransaction":e.params&&(e.params[0]=$(e.params[0]));break;case"personal_sign":e.params&&(e.params=ne(e.params));break}const n=this._formatRequest(e);return await this._sendCallRequest(n,r)}approveRequest(e){if(j(e)){const r=this._formatResponse(e);this._sendResponse(r)}else throw new Error(Nt)}rejectRequest(e){if(F(e)){const r=this._formatResponse(e);this._sendResponse(r)}else throw new Error(Ft)}transportClose(){this._transport.close()}async _sendRequest(e,r){const n=this._formatRequest(e),s=await this._encrypt(n),c=typeof(r==null?void 0:r.topic)<"u"?r.topic:this.peerId,f=JSON.stringify(s),_=typeof(r==null?void 0:r.forcePushNotification)<"u"?!r.forcePushNotification:_t(n);this._transport.send(f,c,_)}async _sendResponse(e){const r=await this._encrypt(e),n=this.peerId,s=JSON.stringify(r),c=!0;this._transport.send(s,n,c)}async _sendSessionRequest(e,r,n){this._sendRequest(e,n),this._subscribeToSessionResponse(e.id,r)}_sendCallRequest(e,r){return this._sendRequest(e,r),this._eventManager.trigger({event:"call_request_sent",params:[{request:e,options:r}]}),this._subscribeToCallResponse(e.id)}_formatRequest(e){if(typeof e.method>"u")throw new Error(xt);return{id:typeof e.id>"u"?ht():e.id,jsonrpc:"2.0",method:e.method,params:typeof e.params>"u"?[]:e.params}}_formatResponse(e){if(typeof e.id>"u")throw new Error(Pt);const r={id:e.id,jsonrpc:"2.0"};if(F(e)){const n=mt(e.error);return Object.assign(Object.assign(Object.assign({},r),e),{error:n})}else if(j(e))return Object.assign(Object.assign({},r),e);throw new Error(oe)}_handleSessionDisconnect(e){const r=e||"Session Disconnected";this._connected||(this._qrcodeModal&&this._qrcodeModal.close(),ue(ee)),this._connected&&(this._connected=!1),this._handshakeId&&(this._handshakeId=0),this._handshakeTopic&&(this._handshakeTopic=""),this._peerId&&(this._peerId=""),this._eventManager.trigger({event:"disconnect",params:[{message:r}]}),this._removeStorageSession(),this.transportClose()}_handleSessionResponse(e,r){r?r.approved?(this._connected?(r.chainId&&(this.chainId=r.chainId),r.accounts&&(this.accounts=r.accounts),this._eventManager.trigger({event:"session_update",params:[{chainId:this.chainId,accounts:this.accounts}]})):(this._connected=!0,r.chainId&&(this.chainId=r.chainId),r.accounts&&(this.accounts=r.accounts),r.peerId&&!this.peerId&&(this.peerId=r.peerId),r.peerMeta&&!this.peerMeta&&(this.peerMeta=r.peerMeta),this._eventManager.trigger({event:"connect",params:[{peerId:this.peerId,peerMeta:this.peerMeta,chainId:this.chainId,accounts:this.accounts}]})),this._manageStorageSession()):this._handleSessionDisconnect(e):this._handleSessionDisconnect(e)}async _handleIncomingMessages(e){if(![this.clientId,this.handshakeTopic].includes(e.topic))return;let n;try{n=JSON.parse(e.payload)}catch{return}const s=await this._decrypt(n);s&&this._eventManager.trigger(s)}_subscribeToSessionRequest(){this._transport.subscribe(this.handshakeTopic)}_subscribeToResponse(e,r){this.on(`response:${e}`,r)}_subscribeToSessionResponse(e,r){this._subscribeToResponse(e,(n,s)=>{if(n){this._handleSessionResponse(n.message);return}j(s)?this._handleSessionResponse(r,s.result):s.error&&s.error.message?this._handleSessionResponse(s.error.message):this._handleSessionResponse(r)})}_subscribeToCallResponse(e){return new Promise((r,n)=>{this._subscribeToResponse(e,(s,c)=>{if(s){n(s);return}j(c)?r(c.result):c.error&&c.error.message?n(new Error(c.error.message)):n(new Error(oe))})})}_subscribeToInternalEvents(){this.on("display_uri",()=>{this._qrcodeModal&&this._qrcodeModal.open(this.uri,()=>{this._eventManager.trigger({event:"modal_closed",params:[]})},this._qrcodeModalOptions)}),this.on("connect",()=>{this._qrcodeModal&&this._qrcodeModal.close()}),this.on("call_request_sent",(e,r)=>{const{request:n}=r.params[0];if(Ne()&&this._signingMethods.includes(n.method)){const s=ae(ee);s&&(window.location.href=s.href)}}),this.on("wc_sessionRequest",(e,r)=>{e&&this._eventManager.trigger({event:"error",params:[{code:"SESSION_REQUEST_ERROR",message:e.toString()}]}),this.handshakeId=r.id,this.peerId=r.params[0].peerId,this.peerMeta=r.params[0].peerMeta;const n=Object.assign(Object.assign({},r),{method:"session_request"});this._eventManager.trigger(n)}),this.on("wc_sessionUpdate",(e,r)=>{e&&this._handleSessionResponse(e.message),this._handleSessionResponse("Session disconnected",r.params[0])})}_initTransport(){this._transport.on("message",e=>this._handleIncomingMessages(e)),this._transport.on("open",()=>this._eventManager.trigger({event:"transport_open",params:[]})),this._transport.on("close",()=>this._eventManager.trigger({event:"transport_close",params:[]})),this._transport.on("error",()=>this._eventManager.trigger({event:"transport_error",params:["Websocket connection failed"]})),this._transport.open()}_formatUri(){const e=this.protocol,r=this.handshakeTopic,n=this.version,s=encodeURIComponent(this.bridge),c=this.key;return`${e}:${r}@${n}?bridge=${s}&key=${c}`}_parseUri(e){const r=Mt(e);if(r.protocol===this.protocol){if(!r.handshakeTopic)throw Error("Invalid or missing handshakeTopic parameter value");const n=r.handshakeTopic;if(!r.bridge)throw Error("Invalid or missing bridge url parameter value");const s=decodeURIComponent(r.bridge);if(!r.key)throw Error("Invalid or missing key parameter value");const c=r.key;return{handshakeTopic:n,bridge:s,key:c}}else throw new Error(Lt)}async _generateKey(){return this._cryptoLib?await this._cryptoLib.generateKey():null}async _encrypt(e){const r=this._key;return this._cryptoLib&&r?await this._cryptoLib.encrypt(e,r):null}async _decrypt(e){const r=this._key;return this._cryptoLib&&r?await this._cryptoLib.decrypt(e,r):null}_getStorageSession(){let e=null;return this._sessionStorage&&(e=this._sessionStorage.getSession()),e}_setStorageSession(){this._sessionStorage&&this._sessionStorage.setSession(this.session)}_removeStorageSession(){this._sessionStorage&&this._sessionStorage.removeSession()}_manageStorageSession(){this._connected?this._setStorageSession():this._removeStorageSession()}_registerPushServer(e){if(!e.url||typeof e.url!="string")throw Error("Invalid or missing pushServerOpts.url parameter value");if(!e.type||typeof e.type!="string")throw Error("Invalid or missing pushServerOpts.type parameter value");if(!e.token||typeof e.token!="string")throw Error("Invalid or missing pushServerOpts.token parameter value");const r={bridge:this.bridge,topic:this.clientId,type:e.type,token:e.token,peerName:"",language:e.language||""};this.on("connect",async(n,s)=>{if(n)throw n;if(e.peerMeta){const c=s.params[0].peerMeta.name;r.peerName=c}try{if(!(await(await fetch(`${e.url}/new`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r)})).json()).success)throw Error("Failed to register in Push Server")}catch{throw Error("Failed to register in Push Server")}})}}function Xt(t){return q.getBrowerCrypto().getRandomValues(new Uint8Array(t))}const Ee=256,Oe=Ee,er=Ee,k="AES-CBC",tr=`SHA-${Oe}`,Q="HMAC",rr="encrypt",nr="decrypt",sr="sign",ir="verify";function or(t){return t===k?{length:Oe,name:k}:{hash:{name:tr},name:Q}}function cr(t){return t===k?[rr,nr]:[sr,ir]}async function Z(t,e=k){return q.getSubtleCrypto().importKey("raw",t,or(e),!0,cr(e))}async function ar(t,e,r){const n=q.getSubtleCrypto(),s=await Z(e,k),c=await n.encrypt({iv:t,name:k},s,r);return new Uint8Array(c)}async function ur(t,e,r){const n=q.getSubtleCrypto(),s=await Z(e,k),c=await n.decrypt({iv:t,name:k},s,r);return new Uint8Array(c)}async function hr(t,e){const r=q.getSubtleCrypto(),n=await Z(t,Q),s=await r.sign({length:er,name:Q},n,e);return new Uint8Array(s)}function dr(t,e,r){return ar(t,e,r)}function fr(t,e,r){return ur(t,e,r)}async function Me(t,e){return await hr(t,e)}async function Te(t){const e=(t||256)/8,r=Xt(e);return rt(P(r))}async function Ce(t,e){const r=M(t.data),n=M(t.iv),s=M(t.hmac),c=O(s,!1),f=ge(r,n),_=await Me(e,f),l=O(_,!1);return v(c)===v(l)}async function lr(t,e,r){const n=T(W(e)),s=r||await Te(128),c=T(W(s)),f=O(c,!1),_=JSON.stringify(t),l=Ge(_),g=await dr(c,n,l),A=O(g,!1),b=ge(g,c),S=await Me(n,b),w=O(S,!1);return{data:A,hmac:w,iv:f}}async function pr(t,e){const r=T(W(e));if(!r)throw new Error("Missing key: required for decryption");if(!await Ce(t,r))return null;const s=M(t.data),c=M(t.iv),f=await fr(c,r,s),_=Je(f);let l;try{l=JSON.parse(_)}catch{return null}return l}const _r=Object.freeze(Object.defineProperty({__proto__:null,decrypt:pr,encrypt:lr,generateKey:Te,verifyHmac:Ce},Symbol.toStringTag,{value:"Module"}));class mr extends zt{constructor(e,r){super({cryptoLib:_r,connectorOpts:e,pushServerOpts:r})}}export{mr as default};
