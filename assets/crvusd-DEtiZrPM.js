import{f as y,a as v,t as _}from"./timestamp-X9wFVw8g.js";import{t as d,f as c,g as i,b,a as h}from"./timestamp-DkvXAN4c.js";import{g as f}from"./api-Bhu-jkhy.js";import{u as n}from"./useQuery-BT8h_fmv.js";import{f as o,u as g}from"./index-CSwO_UPo.js";const k=e=>({name:e.collateral_token.symbol,address:e.address,factoryAddress:e.factory_address,llamma:e.llamma,rate:e.rate,borrowed:e.total_debt,borrowable:e.borrowable,collateralAmount:e.collateral_amount,collateralAmountUsd:e.collateral_amount_usd,debtCeiling:e.debt_ceiling,loans:e.n_loans,collateralToken:{symbol:e.collateral_token.symbol,address:e.collateral_token.address,rebasingYield:e.collateral_token.rebasing_yield},stablecoinToken:{symbol:e.stablecoin_token.symbol,address:e.stablecoin_token.address,rebasingYield:e.stablecoin_token.rebasing_yield},fees:{pending:e.pending_fees,collected:e.collected_fees}}),q=e=>({timestamp:d(e.dt),rate:e.rate,nLoans:e.n_loans,minted:e.minted,redeemed:e.redeemed,totalCollateral:e.total_collateral,totalCollateralUsd:e.total_collateral_usd,totalStablecoin:e.total_stablecoin,totalStablecoinUsd:e.total_stablecoin_usd,totalDebt:e.total_debt,totalDebtUsd:e.total_debt_usd,priceAMM:e.amm_price,priceOracle:e.price_oracle,borrowable:e.borrowable,discountLiquidation:e.liquidation_discount,discountLoan:e.loan_discount,ammA:e.amm_a,basePrice:e.base_price,minBand:e.min_band,maxBand:e.max_band,sumDebtSquared:e.sum_debt_squared,collateralToken:{symbol:e.collateral_token.symbol,address:e.collateral_token.address,rebasingYield:e.collateral_token.rebasing_yield},stablecoinToken:{symbol:e.stablecoin_token.symbol,address:e.stablecoin_token.address,rebasingYield:e.stablecoin_token.rebasing_yield}}),$=e=>({address:e.address,pool:e.pool,poolAddress:e.pool_address,pair:e.pair.map(a=>({symbol:a.symbol,address:a.address})),active:e.active,totalDebt:e.total_debt,totalProfit:e.total_profit}),U=e=>({timestamp:d(e.timestamp),market:e.market,supply:e.supply,borrowable:e.borrowable}),w=e=>e.markets.map(a=>({collateral:a.collateral,controller:a.controller,snapshotFirst:d(a.first_snapshot),snapshotLast:d(a.last_snapshot)})),K=e=>({health:e.health,healthFull:e.health_full,n:e.n,n1:e.n1,n2:e.n2,debt:e.debt,collateral:e.collateral,collateralUp:e.collateral_up,stablecoin:e.stablecoin,softLiquidation:e.soft_liquidation,totalDeposited:e.total_deposited,loss:e.loss,lossPct:e.loss_pct,oraclePrice:e.oracle_price,blockNumber:e.block_number,timestamp:d(e.timestamp)}),M=e=>e.data.map(K),S=e=>({controller:e.controller,user:e.user,totalDeposit:e.total_deposit,totalDepositPrecise:e.total_deposit_precise,totalDepositUsd:e.total_deposit_usd_value,totalBorrowed:e.total_borrowed,totalBorrowedPrecise:e.total_borrowed_precise,events:e.data.map(a=>({timestamp:d(a.dt),txHash:a.transaction_hash,type:a.type,user:a.user,collateralChange:a.collateral_change,collateralChangeUsd:a.collateral_change_usd??void 0,loanChange:a.loan_change,loanChangeUsd:a.loan_change_usd??void 0,liquidation:a.liquidation===null?void 0:{user:a.liquidation.user,liquidator:a.liquidation.liquidator,collateralReceived:a.liquidation.collateral_received,collateralReceivedUsd:a.liquidation.collateral_received_usd,stablecoinReceived:a.liquidation.stablecoin_received,debt:a.liquidation.debt},n1:a.n1,n2:a.n2,oraclePrice:a.oracle_price}))});async function F(e,a={},t){const s=i(t);return(await c(`${s}/v1/crvusd/markets/${e}${b(a)}`)).data.map(k)}async function D(e,a,t={fetch_on_chain:!0,agg:"day"},s){const r=i(s);return(await c(`${r}/v1/crvusd/markets/${e}/${a}/snapshots${b(t)}`)).data.map(q)}async function A(e,a,t){const s=i(t),r=h({daysRange:a});return(await c(`${s}/v1/crvusd/markets/${e}/supply${b(r)}`)).data.map(U)}async function C(e,a){const t=i(a);return(await c(`${t}/v1/crvusd/pegkeepers/${e}`)).keepers.map($)}async function Q(e,a,t){const s=i(t),r=await c(`${s}/v1/crvusd/users/${a}/${e}?page=1&per_page=100&include_closed=false`);return w(r)}async function P(e,a,t,s){const r=i(s),l=await c(`${r}/v1/crvusd/users/${a}/${e}/${t}/snapshots?page=1&per_page=100`);return M(l)}async function L(e,a,t,s){const r=i(s),l=await c(`${r}/v1/crvusd/collateral_events/${a}/${t}/${e}`);return S(l)}function p(){return{initialData:[],initialDataUpdatedAt:0}}function N(e=30){const a=o(()=>g(e));return n({queryKey:["crvusd-supply",a],queryFn:()=>A("ethereum",a.value),...p()})}function j(e){return n({queryKey:["crvusd-market-snapshots",o(()=>e.value?.address)],queryFn:({queryKey:[,a]})=>D("ethereum",a),enabled:o(()=>!!e.value),...p()})}function V(e){return n({queryKey:["crvusd-keepers-prices",o(()=>[...new Set(e.value.map(a=>a.poolAddress))])],queryFn:async()=>{const a=e.value.map(async r=>{const l=r.pair.find(u=>u.symbol!=="crvUSD"),m=r.pair.find(u=>u.symbol==="crvUSD");return!l||!m?[]:(await f("ethereum",r.poolAddress,l.address,m.address)).map(u=>({time:u.time,price:(u.high+u.low)/2,coin:l.symbol}))}),s=(await Promise.all(a)).flat().groupBy(r=>r.time.getTime()).entries().map(([r,l])=>({timestamp:Number(r)/1e3,...Object.fromEntries(l.map(m=>[m.coin,m.price]))}));return s.length>0?s:[{timestamp:0}]},initialData:[{timestamp:0}],initialDataUpdatedAt:0})}function z(){return n({queryKey:["crvusd-markets"],queryFn:()=>F("ethereum",{page:1}),...p()})}function G(){return n({queryKey:["crvusd-keepers"],queryFn:()=>C("ethereum"),...p()})}function I(e,a){return n({queryKey:["crvusd-user-markets",o(()=>e.value),o(()=>a.value)],queryFn:({queryKey:[,t,s]})=>Q(t,s),enabled:o(()=>!!e.value&&!!a.value),...p()})}function W(e,a,t){return n({queryKey:["crvusd-user-market-snapshots",o(()=>e.value),o(()=>a.value),o(()=>t.value)],queryFn:({queryKey:[,s,r,l]})=>P(s,r,l),enabled:o(()=>!!e.value&&!!a.value&&!!t.value),...p()})}function X(e,a,t){return n({queryKey:["crvusd-user-market-events",o(()=>e.value),o(()=>a.value),o(()=>t.value)],queryFn:({queryKey:[,s,r,l]})=>L(s,r,l),enabled:o(()=>!!e.value&&!!a.value&&!!t.value)})}const R=e=>({user:e.user,first:_(e.first),last:_(e.last),debt:parseFloat(e.debt),health:parseFloat(e.health),healthFull:parseFloat(e.health_full),loss:parseFloat(e.loss),stablecoin:parseFloat(e.stablecoin),softLiquidation:e.soft_liquidation});async function T(e,a,t,s){const r=i(s);return(await y(`${r}/v1/crvusd/users/${e}/${a}/users${v(t)}`)).data.map(R)}function Z(e,a){return n({queryKey:["crvusd-market-all-users",o(()=>e.value),o(()=>a.value)],queryFn:({queryKey:[,t,s]})=>T(t,s,{per_page:1e3}),enabled:o(()=>!!e.value&&!!a.value)})}export{W as a,X as b,I as c,N as d,j as e,Z as f,G as g,V as h,z as u};
